---
title: "[컴퓨터구조&운영체제] 4. CPU의 작동 원리"
excerpt: "CPU의 작동 원리"

categories:
  - Concept
tags:
  - [concept, CS&OS]

permalink: /concept/cs-&-os-4/

toc: true
toc_sticky: true

date: 2023-07-02
last_modified_at: 2023-10-27
---
# 4. CPU의 작동 원리 

## ALU 

레지스터 - 피연산자 ->  |ALU| - 결괏값 -> 레지스터
제어장치 - 제어신호 ->  |ALU|- 플래그 ->  플래그 레지스터 

ALU: Arithmetic and Logical Unit 

### Input
- 레지스터를 통해 피연산자를 받아들임
- 제어장치를 통해 제어 신호를 받아들임
- 피연산자와 제어 신호로 산술 연산, 논리 연산 등 다양한 연산 수행 

### Output
- 연산 수행의 결과는 숫자나 문자, 주소 등 여러 형태
- 결과값은 바로 메모리에 저장되지 않고 일시적으로 레지스터에 저장됨
- CPU의 메모리 접근 속도가 레지스터 접근 속도보다 느리기 때문에 연산마다 결과를 메모리에 저장하는 대신 레지스터에 우선 저장함
- 계산 결과와 더불어 `플래그`를 내보냄
```
플래그: 연산 결과에 대한 추가적인 상태 정보
1. 부호 플래그: 부호를 나타냄
2. 제로 플래그: 0인지 여부
3. 캐리 플래그: 올림수나 빌림수 발생 여부
4. 오버플로우: 오버플로우 발생 여부
5. 인터럽트: 인터럽트 가능 여부
6. 슈퍼바이저: 커널 모드/사용자 모드
플래그의 값은 플래그 레지스터에 저장
``` 

## 제어 장치
제어 신호를 보내고 명령어를 해석하는 부품
제어 신호: 컴퓨터 부품들을 관리하고 작동시키기 위한 일종의 전기 신호 

### 제어 장치가 받아들이는 정보
1. 클럭 신호
클럭: 컴퓨터 부품을 움직이는 시간 단위 

2. 해석해야 할 명령어
명령어 레지스터에 저장된 명령어 받아들여 해석 후 제어 신호 발생 

3. 플래그 레지스터 속 플래그 값 

4. 시스템 버스 중 제어 버스로 전달된 제어 신호
입출력장치를 비롯한 CPU 외부 장치도 제어 신호를 발생시킬 수 있음
제어 장치는 제어버스를 통해 외부로부터 전달된 제어 신호를 받아들이기도 함 

### 제어 장치가 내보내는 정보
1. CPU 외부에 전달하는 제어 신호
= 제어 버스로 보내는 제어 신호
- 메모리에 전달하는 제어 신호: 메모리에 저장된 값을 읽거나 메모리에 새로운 값을 쓰는 경우 

- 입출력장치에 전달하는 제어 신호: 입출력장치에 저장된 값을 읽거나 입출력장치에 새로운 값을 쓰는 경우


2. CPU 내부에 전달하는 제어 신호
- ALU에 전달하는 제어 신호: ALU에 수행할 연산을 지시하기 위해 

- 레지스터에 전달하는 제어 신호: 레지스터 간 데이터 이동 혹은 레지스터에 저장된 명령어 해석 

## 레지스터
프로그램 속 명령어와 데이터는 실행 전후로 반드시 레지스터에 저장됨
따라서 레지스터에 저장된 값을 통해 실행 흐름 파악 가능 

### 중요한 레지스터 

1. 프로그램 카운터 PC
- 메모리에서 읽어 들일 명령어의 주소 저장
- Instruction Pointer라고 부르는 CPU도 있음 

2. 명령어 레지스터 Instruction R
- 해석할 명령어 = 메모리에서 읽어 들인 명령어 저장
- 제어 장치는 IR 속 명령어를 받아들여 해석한 뒤 제어 신호 보냄 

3. 메모리 주소 레지스터 MAR
- 메모리의 주소 저장
- CPU가 읽어 들이고자 하는 주소 값을 주소 버스로 보낼 때 거침 

4. 메모리 버퍼 레지스터 MBR
- 메모리와 주고받을 값인 데이터와 명령어를 저장
- 메모리에 쓰고 싶은 값이나 전달받은 값이 거쳐감
- CPU가 데이터 버스로 주고받을 값이 거쳐감 

5. 범용 레지스터 general purpose register
- 데이터와 주소 모두 저장 가능
- 일반적으로 한 CPU 내에 여러 개가 존재 

6. 플래그 레지스터
- ALU 연산 결과에 따른 플래그 저장 

### 특정 레지스터를 이용한 주소 지정 방식 

1. 스택 주소 지정 방식
스택과 스택 포인터를 이용한 주소 지정 방식 

- 스택 포인터: 스택의 꼭대기를 가리키는 레지스터;스택에 데이터가 채워져 있는 정도를 표시함
- 스택에서 데이터를 꺼내거나 추가할 때; 스택의 꼭대기 주소가 달라져 스택 포인터가 가리키는 곳도 달라짐
- 스택 영역: 메모리 안에 지정된 스택처럼 사용할 영역 

2. 변위 주소 지정 방식 displacement addressing mode
오퍼랜드 필드의 값(= 변위)과 특정 레지스터의 값을 더해 유효 주소를 얻어내는 주소 지정 방식 

- 변위 주소 지정 방식을 사용하는 명령어: `연산 코드 / 레지스터 / 오퍼랜드` 세 필드로 나누어져 있음
- 오퍼랜드 필드의 주소에 더하는 레지스터에 따라 나뉨 

1) 상대 주소 지정 방식 relative addressing mode
- 오퍼랜드 + 프로그램 카운터
- 프로그램 카운터: 읽어 들일 명령어의 주소 저장
- 프로그램 카운터의 값에 따라 읽어 들이기로 한 명령어의 주소가 달라짐
- `if`문과 유사하게 분기하여 특정 주소의 코드를 실행할 때 사용 

2) 베이스 레지스터 주소 지정 방식
- 오퍼랜드 + 베이스 레지스터
- 베이스 레지스터: 기준 주소
- 오퍼랜드: 기준 주소로부터 떨어진 거리
- 기존 주소로부터 얼마나 떨어진 주소에 접근할 것인지 연산하여 유효 주소를 얻어내는 방식 

## 명령어 사이클 instruction cycle
하나의 명령어를 처리하는 정형화된 흐름
프로그램 속 명령어들의 반복 실행되는 일정한 주기 

1. 인출 사이클 fetch cycle
- 메모리에 있는 명령어를 CPU로 가지고 오는 단계 

2. 실행 사이클 execution cycle
- CPU로 가져온 명령어를 실행하는 단계
- 명령에 레지스터에 담긴 값을 CU가 해석하고 제어 신호를 발생시키는 단계 

인출 사이클과 실행 사이클이 반복되면서 프로그램이 실행됨 

3. 간접 사이클 indirect cycle
- 명령어를 실행하기 위해서 추가적으로 메모리에 접근하는 단계
- 명령어를 인출해 CPU로 가져와도 바로 실행할 수 없는 경우
- ex. 간접 주소 지정 방식에서 오퍼랜드 필드에 명시된 유효 주소의 주소를 통해 다시 메모리에 접근하는 경우 

## 인터럽트
CPU가 명령어를 처리하는 정해진 흐름이 끊기는 상황
CPU의 작업을 방해하는 신호 

1. 동기 인터럽트 synchronous interrupts
CPU에 의해 발생하는 인터럽트
- 명령어를 수행하던 중 예상치 못한 상황에 바주했을 때 발생
- ex. 프로그래밍상의 오류
- 예외 exception 라고도 부름 

2. 비동기 인터럽트 asynchronous interrupts
주로 입출력장치에 의해 발생하는 인터럽트
- 입출력장치가 보내는 알림 등이 여기 속함
- ex. 작업을 끝냈다는 신호, 입력을 받아들였을 때의 알림 등
- 인터럽트 혹은 하드웨어 인터럽트라고도 부름 

3. 하드웨어 인터럽트
입출력장치에 의해 발생하는 인터럽트
- 입출력 작업 도중 효율적인 명령어 처릴 위해 사용
- 주기적으로 완료 여부 혹은 입력 여부와 같은 것들을 확인하는 대신 인터럽트를 사용해 알림을 보냄 = 경제적 

### 인터럽트의 처리
처리 순서
```
1. 입출력장치: CPU에 `인터럽트 요청 신호` 보냄
2. CPU: 실행 사이클이 끝나고 명령어를 인출하기 전 항상 인터럽트 여부 확인
3. CPU: 인터럽트 요청 확인 후 `인터럽트 플래그`를 통해 현재 인터럽트를 받아들일 수 있는지 여부를 확인
4. CPU: 인터럽트를 받아들일 수 있다면 지금까지의 작업 백업
5. CPU: `인터럽트 벡터`를 참조해 `인터럽트 서비스 루틴` 실행
6. 인터럽트 서비스 루틴이 끝나면 `4`에서 백업된 작업 복구하여 실행 재개
```
1. 인터럽트 요청 신호: 인터럽트 전 CPU에 보내는 신호 

2. 인터럽트 플래그: 하드웨어 인터럽트 수용 여부가 저장된 플래그
- 단, 무시할 수 없는 인터럽트 요쳥도 있음; 우선순위가 높은 인터럽트
- ex. 정전이나 하드웨어 고장으로 인한 인터럽트 

3. 인터럽트 서비스 루틴 = 인터럽트 핸들러: 인터럽트를 처리하기 위한 프로그램
- 인터럽트 발생 시 처리 및 작동 방법에 대한 정보로 이루어짐
- 프로그램 카운터를 비롯한 레지스터를 사용 

4. 인터럽트 벡터: 인터럽트 서비스 루틴을 식별하기 위한 정보
- 인터럽트 서비스 루틴의 시작 주소를 알 수 있음
- 인터럽트 서비스 루틴을 실행하기 위해 필요 

인터럽트를 처리한다 = 인터럽트 서비스 루틴을 실행하고 본래 수행하던 작업으로 돌아온다
- 인터럽트 발생 전까지 레지스터에 저자되어 있던 값들은 스택에 백업됨 

### 예외의 종류
예외가 발생했을 때 실행하는 명령어에 따라 나뉨 

1. 폴트 fault
예외를 처리한 직후 예외가 발생한 명령어부터 실행 재개 

```
1. 어떤 명령어를 실행하기 위해 반드시 필요한 데이터가 보조기억장치에 있음
2. 프로그램 실행을 위해서 그 데이터를 메모리에 저장해야 함
3. 그를 위해 CPU는 폴트 발생 후 보조기억장치로부터 필요한 데이터를 메모리로 가져와 저장
4. 보조기억장치로부터 필요한 데이터를 메모리로 가져와 저장
5. 실행을 재개한 CPU는 폴트가 발생한 그 명령어 = 보조기억장치에 있는 데이터가 필요하던 명령어부터 실행
``` 

2. 트랩 trap
예외를 처리한 직후 예외가 발생한 명령어의 다음 명령어부터 실행을 재개
- 주로 디버깅 시 사용
- 특정 코드가 실행되는 순간 프로그램의 실행을 멈추는 경우에 사용 

3. 중단 abort
실행 중인 프로그램을 강제로 중단시켜야 하는 심각한 오류를 발견한 경우 발생 

4. 소프트웨어 인터럽트
시스템 호출이 발생했을 때